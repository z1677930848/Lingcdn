{$layout}
{$template "/echarts"}

<div class="dashboard-page" v-cloak="">
    <!-- 全局加载遮罩 -->
    <Spin fix v-if="isLoading">
        <Icon type="ios-loading" size="18" class="spin-icon-load"></Icon>
        <div style="margin-top: 8px">数据加载中...</div>
    </Spin>

    <!-- 提醒区 -->
    <div class="alerts" v-if="!isLoading">
        <Alert type="warning" show-icon closable v-if="teaXFFPrompt">
            检测到你正在使用反向代理访问当前系统，请在安全设置中设置“自定义客户端IP报头”。
            <a href="/settings/security?showAll=1#client-header-names" class="alert-link">去设置</a>
            <template slot="desc">
                <a href="" @click.prevent="dismissXFFPrompt" class="alert-link">关闭提示</a>
            </template>
        </Alert>

        <Alert type="error" show-icon closable v-if="newVersionCode.length > 0">
            升级提醒：有新版本管理系统可以更新：v{{currentVersionCode}} → v{{newVersionCode}}
            <a href="/settings/updates?doCheck=1" class="alert-link">查看详情</a>
        </Alert>

        <Alert type="error" show-icon closable v-if="nodeUpgradeInfo.count > 0">
            升级提醒：有 {{nodeUpgradeInfo.count}} 个边缘节点需要升级到 v{{nodeUpgradeInfo.version}}，系统正在尝试自动升级，请耐心等待...
            <a href="/clusters" class="alert-link">查看节点</a>
        </Alert>

        <Alert type="error" show-icon closable v-if="apiNodeUpgradeInfo.count > 0">
            升级提醒：有 {{apiNodeUpgradeInfo.count}} 个API节点需要升级到 v{{apiNodeUpgradeInfo.version}}；如果已经升级，请尝试重启API节点进程。
            <a href="/settings/api" class="alert-link">前往设置</a>
        </Alert>

        <Alert type="error" show-icon closable v-if="localLowerVersionAPINode != null">
            <span v-if="localLowerVersionAPINode.runtimeVersion == localLowerVersionAPINode.fileVersion">
                升级提醒：发现本地API节点版本需要升级，位置：{{localLowerVersionAPINode.exePath}}，当前版本：v{{localLowerVersionAPINode.runtimeVersion}}
            </span>
            <span v-else>
                升级提醒：本地API节点文件已更新需重启生效，位置：{{localLowerVersionAPINode.exePath}}
                <a href="" @click.prevent="restartAPINode" v-if="!isRestartingLocalAPINode" class="alert-link">帮我重启</a>
                <span v-else>尝试重启中...</span>
            </span>
        </Alert>

        <Alert type="error" show-icon closable v-if="dashboard.diskUsageWarning != null && dashboard.diskUsageWarning.length > 0">
            <span v-html="dashboard.diskUsageWarning"></span>
        </Alert>

        <Alert type="error" show-icon closable v-if="countWeakAdmins > 0">
            安全提醒：有 {{countWeakAdmins}} 个管理员使用弱密码，请及时修改。
            <a href="/admins?hasWeakPassword=1" class="alert-link">查看</a>
        </Alert>
    </div>

    <div v-if="!isLoading" class="dashboard-content">
        <!-- 顶部指标卡片 -->
        <Row :gutter="16" class="metric-row">
            <Col :xs="12" :sm="8" :md="6" v-for="card in metricCards" :key="card.key">
                <Card :bordered="false" class="metric-card" shadow>
                    <div class="metric-title">{{card.title}}</div>
                    <div class="metric-value">
                        <span>{{card.value}}</span>
                        <span class="metric-sub" v-if="card.extra && card.extra.length > 0">{{card.extra}}</span>
                    </div>
                </Card>
            </Col>
        </Row>

        <!-- 流量趋势与域名排行 -->
        <Row :gutter="16" class="chart-row">
            <Col :xs="24" :md="14">
                <Card :bordered="false" shadow>
                    <div class="card-header">
                        <div class="card-title">
                            <Icon type="ios-pulse"></Icon>
                            <span>流量趋势</span>
                        </div>
                        <RadioGroup type="button" size="small" v-model="trafficTab" @on-change="selectTrafficTab">
                            <Radio label="hourly">24小时</Radio>
                            <Radio label="daily">15天</Radio>
                        </RadioGroup>
                    </div>
                    <div class="chart-box" id="hourly-traffic-chart-box" v-show="trafficTab == 'hourly'"></div>
                    <div class="chart-box" id="daily-traffic-chart-box" v-show="trafficTab == 'daily'"></div>
                </Card>
            </Col>
            <Col :xs="24" :md="10">
                <Card :bordered="false" shadow>
                    <div class="card-header">
                        <div class="card-title">
                            <Icon type="ios-podium"></Icon>
                            <span>域名访问排行</span>
                            <span class="card-sub">最近24小时</span>
                        </div>
                    </div>
                    <div class="chart-box" id="top-domains-chart"></div>
                </Card>
            </Col>
        </Row>

        <!-- 自定义指标组件 -->
        <div class="metric-chart-list" v-if="metricCharts != null && metricCharts.length > 0">
            <metric-chart v-for="chart in metricCharts"
                          :key="chart.id"
                          :v-chart="chart.chart"
                          :v-stats="chart.stats"
                          :v-item="chart.item"
                          :v-column="true">
            </metric-chart>
        </div>
    </div>
</div>
